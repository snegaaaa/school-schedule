<!doctype html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</title>
  <link rel="stylesheet" th:href="@{/css/app.css}">
  <style>
    .filterbar{
      display:flex;
      gap:10px;
      align-items:center;
      margin:10px 0 12px;
    }
    .filterbar .input{ width:100%; }
    .nores{ color:var(--muted); font-size:13px; padding:10px 0; }

    th.sortable{
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    th.sortable:hover{
      background: rgba(13,110,253,.04);
    }
    .sort-ind{
      display:inline-block;
      margin-left:6px;
      color: var(--muted);
      font-weight:900;
    }
  </style>
</head>
<body>
<div class="container">

  <div class="topbar">
    <div class="brand">
      <a class="brand-title" th:href="@{/}">–®–∫–æ–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
      <p class="brand-sub">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</p>
    </div>

    <div class="nav">
      <a th:href="@{/schedule}">üìÖ –ü–æ –¥–Ω—è–º</a>
      <a th:href="@{/schedule/week}">üóìÔ∏è –ù–µ–¥–µ–ª—è</a>
      <a th:href="@{/stats}">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
      <a th:href="@{/about}">‚ÑπÔ∏è –û–± –∞–≤—Ç–æ—Ä–µ</a>

      <span sec:authorize="hasRole('ADMIN')" class="inline">
        <a th:href="@{/classes}">üè´ –ö–ª–∞—Å—Å—ã</a>
        <a class="active" th:href="@{/setup}">üß© –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</a>
        <a th:href="@{/admin/users}">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
      </span>
    </div>

    <div class="userbox">
      <div class="badge">üë§ <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</span> <b sec:authentication="name">user</b></div>
      <form th:action="@{/logout}" method="post" style="margin:0;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <button class="btn" type="submit">–í—ã–π—Ç–∏</button>
      </form>
    </div>
  </div>

  <div class="pagehead">
    <h1>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</h1>
    <p>–ü—Ä–µ–¥–º–µ—Ç—ã, —É—á–∏—Ç–µ–ª—è –∏ –∫–∞–±–∏–Ω–µ—Ç—ã.</p>
  </div>

  <div th:if="${error != null}" class="card">
    <div class="alert alert-danger" th:if="${error == 'empty'}">–ü–æ–ª–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.</div>
    <div class="alert alert-danger" th:if="${error == 'format'}">–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–Ω–∞—á–µ–Ω–∏—è.</div>
    <div class="alert alert-danger" th:if="${error == 'duplicate'}">–¢–∞–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.</div>
    <div class="alert alert-danger" th:if="${error == 'notFound'}">–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (–≤–æ–∑–º–æ–∂–Ω–æ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ).</div>
    <div class="alert alert-danger" th:if="${error == 'inUse'}">–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ: –∑–Ω–∞—á–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏.</div>
    <div class="alert alert-warn" th:if="${error == 'disabled'}">–§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞.</div>
  </div>

  <div class="grid" style="margin-top:16px;">

    <!-- SUBJECTS -->
    <div class="card">
      <div class="h2">–ü—Ä–µ–¥–º–µ—Ç—ã</div>

      <div sec:authorize="hasRole('ADMIN')">
        <form class="form" method="post" action="/setup/subject">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
          <div class="field">
            <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
            <input class="input" name="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞">
          </div>
          <button class="btn" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
        <hr class="hr">
      </div>

      <div class="filterbar">
        <input id="subjectFilter" class="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º‚Ä¶">
      </div>

      <table id="subjectsTable" class="table">
        <tr>
          <th class="sortable" data-col="0" data-type="text">
            –ù–∞–∑–≤–∞–Ω–∏–µ <span class="sort-ind"></span>
          </th>
          <th style="width:220px;" sec:authorize="hasRole('ADMIN')">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>

        <tr th:each="s : ${subjects}" data-row="1">
          <td th:text="${s.name}">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</td>
          <td sec:authorize="hasRole('ADMIN')" class="inline" style="gap:10px;">
            <a class="btn btn-link" th:href="'/setup/subject/edit?id=' + ${s.id}">–ò–∑–º–µ–Ω–∏—Ç—å</a>
            <form method="post" action="/setup/subject/delete" style="margin:0;">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
              <input type="hidden" name="id" th:value="${s.id}">
              <button class="btn btn-danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
          </td>
        </tr>

        <tr class="no-results" style="display:none;" sec:authorize="hasRole('ADMIN')">
          <td colspan="2" class="nores">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</td>
        </tr>
        <tr class="no-results" style="display:none;" sec:authorize="!hasRole('ADMIN')">
          <td colspan="1" class="nores">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</td>
        </tr>
      </table>
    </div>

    <!-- TEACHERS -->
    <div class="card">
      <div class="h2">–£—á–∏—Ç–µ–ª—è</div>

      <div sec:authorize="hasRole('ADMIN')">
        <form class="form" method="post" action="/setup/teacher">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
          <div class="field">
            <div class="label">–§–ò–û</div>
            <input class="input" name="fullName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò.–ò.">
          </div>
          <button class="btn" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
        <hr class="hr">
      </div>

      <div class="filterbar">
        <input id="teacherFilter" class="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ —É—á–∏—Ç–µ–ª—è–º‚Ä¶">
      </div>

      <table id="teachersTable" class="table">
        <tr>
          <th class="sortable" data-col="0" data-type="text">
            –§–ò–û <span class="sort-ind"></span>
          </th>
          <th style="width:220px;" sec:authorize="hasRole('ADMIN')">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>

        <tr th:each="t : ${teachers}" data-row="1">
          <td th:text="${t.fullName}">–ò–≤–∞–Ω–æ–≤ –ò.–ò.</td>
          <td sec:authorize="hasRole('ADMIN')" class="inline" style="gap:10pxhookts;">
            <a class="btn btn-link" th:href="'/setup/teacher/edit?id=' + ${t.id}">–ò–∑–º–µ–Ω–∏—Ç—å</a>
            <form method="post" action="/setup/teacher/delete" style="margin:0;">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
              <input type="hidden" name="id" th:value="${t.id}">
              <button class="btn btn-danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
          </td>
        </tr>

        <tr class="no-results" style="display:none;" sec:authorize="hasRole('ADMIN')">
          <td colspan="2" class="nores">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</td>
        </tr>
        <tr class="no-results" style="display:none;" sec:authorize="!hasRole('ADMIN')">
          <td colspan="1" class="nores">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</td>
        </tr>
      </table>
    </div>

    <!-- ROOMS -->
    <div class="card">
      <div class="h2">–ö–∞–±–∏–Ω–µ—Ç—ã</div>

      <div sec:authorize="hasRole('ADMIN')">
        <form class="form" method="post" action="/setup/room">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
          <div class="field">
            <div class="label">–ù–æ–º–µ—Ä</div>
            <input class="input" name="number" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 101">
          </div>
          <button class="btn" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
        <hr class="hr">
      </div>

      <div class="filterbar">
        <input id="roomFilter" class="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º‚Ä¶">
      </div>

      <table id="roomsTable" class="table">
        <tr>
          <th class="sortable" data-col="0" data-type="smart">
            –ù–æ–º–µ—Ä <span class="sort-ind"></span>
          </th>
          <th style="width:220px;" sec:authorize="hasRole('ADMIN')">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>

        <tr th:each="r : ${rooms}" data-row="1">
          <td th:text="${r.number}">101</td>
          <td sec:authorize="hasRole('ADMIN')" class="inline" style="gap:10px;">
            <a class="btn btn-link" th:href="'/setup/room/edit?id=' + ${r.id}">–ò–∑–º–µ–Ω–∏—Ç—å</a>
            <form method="post" action="/setup/room/delete" style="margin:0;">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
              <input type="hidden" name="id" th:value="${r.id}">
              <button class="btn btn-danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
          </td>
        </tr>

        <tr class="no-results" style="display:none;" sec:authorize="hasRole('ADMIN')">
          <td colspan="2" class="nores">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</td>
        </tr>
        <tr class="no-results" style="display:none;" sec:authorize="!hasRole('ADMIN')">
          <td colspan="1" class="nores">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</td>
        </tr>
      </table>
    </div>

  </div>

</div>

<script>
  function normalizeText(s){
    return (s || '').toString().trim().toLowerCase();
  }

  function getKeyByType(text, type){
    const t = normalizeText(text);
    if (type === 'number'){
      const n = parseFloat(t.replace(',', '.'));
      return isNaN(n) ? Number.POSITIVE_INFINITY : n;
    }
    if (type === 'smart'){
      const n = parseFloat(t.replace(',', '.'));
      if (!isNaN(n) && t.match(/^[-+]?\d+([.,]\d+)?$/)) return n;
      return t;
    }
    return t;
  }

  function applyNoResults(table){
    const rows = Array.from(table.querySelectorAll('tr[data-row="1"]'));
    const noRows = Array.from(table.querySelectorAll('tr.no-results'));
    const anyVisible = rows.some(r => r.style.display !== 'none');
    for (const nr of noRows) nr.style.display = anyVisible ? 'none' : '';
  }

  function bindFilter(inputId, tableId) {
    const input = document.getElementById(inputId);
    const table = document.getElementById(tableId);
    if (!input || !table) return;

    const rows = Array.from(table.querySelectorAll('tr[data-row="1"]'));

    function apply() {
      const q = normalizeText(input.value);
      for (const tr of rows) {
        const text = normalizeText(tr.innerText);
        const show = q === '' || text.includes(q);
        tr.style.display = show ? '' : 'none';
      }
      applyNoResults(table);
    }

    input.addEventListener('input', apply);
    apply();
  }

  function bindSort(tableId){
    const table = document.getElementById(tableId);
    if (!table) return;

    const headers = Array.from(table.querySelectorAll('th.sortable'));
    if (headers.length === 0) return;

    function updateIndicators(activeTh, dir){
      for (const th of headers){
        const ind = th.querySelector('.sort-ind');
        if (!ind) continue;
        ind.textContent = (th === activeTh) ? (dir === 'asc' ? '‚ñ≤' : '‚ñº') : '';
      }
    }

    for (const th of headers){
      th.addEventListener('click', () => {
        const col = parseInt(th.getAttribute('data-col') || '0', 10);
        const type = th.getAttribute('data-type') || 'text';

        const prevCol = table.getAttribute('data-sort-col');
        const prevDir = table.getAttribute('data-sort-dir') || 'asc';

        const dir = (prevCol === String(col) && prevDir === 'asc') ? 'desc' : 'asc';
        table.setAttribute('data-sort-col', String(col));
        table.setAttribute('data-sort-dir', dir);

        const rows = Array.from(table.querySelectorAll('tr[data-row="1"]'));
        rows.sort((a, b) => {
          const aCell = a.children[col];
          const bCell = b.children[col];
          const aKey = getKeyByType(aCell ? aCell.innerText : '', type);
          const bKey = getKeyByType(bCell ? bCell.innerText : '', type);

          if (aKey < bKey) return dir === 'asc' ? -1 : 1;
          if (aKey > bKey) return dir === 'asc' ? 1 : -1;
          return 0;
        });

        const anchor = table.querySelector('tr.no-results');
        for (const r of rows){
          table.insertBefore(r, anchor);
        }

        applyNoResults(table);
        updateIndicators(th, dir);
      });
    }

    updateIndicators(null, 'asc');
  }

  document.addEventListener('DOMContentLoaded', () => {
    bindFilter('subjectFilter', 'subjectsTable');
    bindFilter('teacherFilter', 'teachersTable');
    bindFilter('roomFilter', 'roomsTable');

    bindSort('subjectsTable');
    bindSort('teachersTable');
    bindSort('roomsTable');
  });
</script>

</body>
</html>
