<!doctype html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–ö–ª–∞—Å—Å—ã</title>
  <link rel="stylesheet" th:href="@{/css/app.css}">
  <style>
    .filterbar{
      display:flex;
      gap:10px;
      align-items:center;
      margin:10px 0 12px;
    }
    .filterbar .input{ width:100%; }
    .nores{ color:var(--muted); font-size:13px; padding:10px 0; }

    th.sortable{
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    th.sortable:hover{
      background: rgba(13,110,253,.04);
    }
    .sort-ind{
      display:inline-block;
      margin-left:6px;
      color: var(--muted);
      font-weight:900;
    }
  </style>
</head>
<body>
<div class="container">

  <div class="topbar">
    <div class="brand">
      <a class="brand-title" th:href="@{/}">–®–∫–æ–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
      <p class="brand-sub">–ö–ª–∞—Å—Å—ã</p>
    </div>

    <div class="nav">
      <a th:href="@{/schedule}">üìÖ –ü–æ –¥–Ω—è–º</a>
      <a th:href="@{/schedule/week}">üóìÔ∏è –ù–µ–¥–µ–ª—è</a>
      <a th:href="@{/stats}">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
      <a th:href="@{/about}">‚ÑπÔ∏è –û–± –∞–≤—Ç–æ—Ä–µ</a>

      <span sec:authorize="hasRole('ADMIN')" class="inline">
        <a class="active" th:href="@{/classes}">üè´ –ö–ª–∞—Å—Å—ã</a>
        <a th:href="@{/setup}">üß© –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</a>
        <a th:href="@{/admin/users}">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
      </span>
    </div>

    <div class="userbox">
      <div class="badge">üë§ <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</span> <b sec:authentication="name">user</b></div>
      <form th:action="@{/logout}" method="post" style="margin:0;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <button class="btn" type="submit">–í—ã–π—Ç–∏</button>
      </form>
    </div>
  </div>

  <div class="pagehead">
    <h1>–ö–ª–∞—Å—Å—ã</h1>
    <p>–°–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∫–ª–∞—Å—Å–∞.</p>
  </div>

  <div th:if="${error != null}" class="card">
    <div th:if="${error == 'empty'}" class="alert alert-danger">
      –ò–º—è –∫–ª–∞—Å—Å–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.
    </div>

    <div th:if="${error == 'format'}" class="alert alert-danger">
      –§–æ—Ä–º–∞—Ç: <b>1‚Äì11</b> + <b>—Ä—É—Å—Å–∫–∞—è –∑–∞–≥–ª–∞–≤–Ω–∞—è –±—É–∫–≤–∞</b> (–ø—Ä–∏–º–µ—Ä: 7–ê, 11–ë).
      <span th:if="${value != null}">–í–≤–µ–¥–µ–Ω–æ: <b th:text="${value}"></b></span>
    </div>

    <div th:if="${error == 'duplicate'}" class="alert alert-danger">
      –¢–∞–∫–æ–π –∫–ª–∞—Å—Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
      <span th:if="${value != null}">–í–≤–µ–¥–µ–Ω–æ: <b th:text="${value}"></b></span>
    </div>

    <div th:if="${error == 'notFound'}" class="alert alert-danger">
      –ö–ª–∞—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ —É–∂–µ —É–¥–∞–ª—ë–Ω).
    </div>

    <div th:if="${error == 'inUse'}" class="alert alert-danger">
      –ö–ª–∞—Å—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.
    </div>
  </div>

  <div class="grid" style="margin-top:16px;">
    <div class="card" sec:authorize="hasRole('ADMIN')">
      <div class="h2">–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å</div>
      <form class="form" method="post" action="/classes">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <div class="field">
          <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
          <input class="input" name="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 7–ê">
        </div>
        <button class="btn" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
      </form>
    </div>

    <div class="card">
      <div class="h2">–°–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Å–æ–≤</div>

      <div class="filterbar">
        <input id="classFilter" class="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–ª–∞—Å—Å–∞–º‚Ä¶ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 7–ê)">
      </div>

      <table id="classesTable" class="table">
        <tr>
          <th class="sortable" data-col="0" data-type="class">
            –ö–ª–∞—Å—Å <span class="sort-ind"></span>
          </th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>

        <tr th:each="c : ${classes}" data-row="1">
          <td><b th:text="${c.name}">7–ê</b></td>
          <td class="inline" style="gap:10px; flex-wrap:wrap;">
            <a class="btn btn-link" th:href="'/schedule/week?classId=' + ${c.id}">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>

            <span sec:authorize="hasRole('ADMIN')" class="inline" style="gap:10px;">
              <a class="btn btn-link" th:href="'/classes/edit?id=' + ${c.id}">–ò–∑–º–µ–Ω–∏—Ç—å</a>

              <form method="post" action="/classes/delete" style="margin:0;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <input type="hidden" name="id" th:value="${c.id}">
                <button class="btn btn-danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            </span>
          </td>
        </tr>

        <tr class="no-results" style="display:none;">
          <td colspan="2" class="nores">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</td>
        </tr>
      </table>
    </div>
  </div>

</div>

<script>
  function normalizeText(s){
    return (s || '').toString().trim().toLowerCase();
  }

  function parseClassKey(text){
    const t = (text || '').toString().trim().toUpperCase();
    const m = t.match(/^(\d{1,2})\s*([–ê-–Ø–ÅA-Z])$/u);
    if (!m) return { num: 999, letter: t };
    return { num: parseInt(m[1], 10), letter: m[2] };
  }

  function applyNoResults(table){
    const rows = Array.from(table.querySelectorAll('tr[data-row="1"]'));
    const noRow = table.querySelector('tr.no-results');
    const anyVisible = rows.some(r => r.style.display !== 'none');
    if (noRow) noRow.style.display = anyVisible ? 'none' : '';
  }

  function bindFilter(inputId, tableId) {
    const input = document.getElementById(inputId);
    const table = document.getElementById(tableId);
    if (!input || !table) return;

    const rows = Array.from(table.querySelectorAll('tr[data-row="1"]'));

    function apply() {
      const q = normalizeText(input.value);
      for (const tr of rows) {
        const text = normalizeText(tr.innerText);
        const show = q === '' || text.includes(q);
        tr.style.display = show ? '' : 'none';
      }
      applyNoResults(table);
    }

    input.addEventListener('input', apply);
    apply();
  }

  function bindSort(tableId){
    const table = document.getElementById(tableId);
    if (!table) return;

    const headers = Array.from(table.querySelectorAll('th.sortable'));
    if (headers.length === 0) return;

    function updateIndicators(activeTh, dir){
      for (const th of headers){
        const ind = th.querySelector('.sort-ind');
        if (!ind) continue;
        ind.textContent = (th === activeTh) ? (dir === 'asc' ? '‚ñ≤' : '‚ñº') : '';
      }
    }

    for (const th of headers){
      th.addEventListener('click', () => {
        const col = parseInt(th.getAttribute('data-col') || '0', 10);
        const type = th.getAttribute('data-type') || 'text';

        const prevCol = table.getAttribute('data-sort-col');
        const prevDir = table.getAttribute('data-sort-dir') || 'asc';

        const dir = (prevCol === String(col) && prevDir === 'asc') ? 'desc' : 'asc';
        table.setAttribute('data-sort-col', String(col));
        table.setAttribute('data-sort-dir', dir);

        const rows = Array.from(table.querySelectorAll('tr[data-row="1"]'));
        rows.sort((a, b) => {
          const aCell = a.children[col];
          const bCell = b.children[col];
          const aText = aCell ? aCell.innerText : '';
          const bText = bCell ? bCell.innerText : '';

          if (type === 'class') {
            const A = parseClassKey(aText);
            const B = parseClassKey(bText);
            if (A.num !== B.num) return dir === 'asc' ? (A.num - B.num) : (B.num - A.num);
            if (A.letter < B.letter) return dir === 'asc' ? -1 : 1;
            if (A.letter > B.letter) return dir === 'asc' ? 1 : -1;
            return 0;
          }

          const A = normalizeText(aText);
          const B = normalizeText(bText);
          if (A < B) return dir === 'asc' ? -1 : 1;
          if (A > B) return dir === 'asc' ? 1 : -1;
          return 0;
        });

        const anchor = table.querySelector('tr.no-results');
        for (const r of rows){
          table.insertBefore(r, anchor);
        }

        applyNoResults(table);
        updateIndicators(th, dir);
      });
    }

    updateIndicators(null, 'asc');
  }

  document.addEventListener('DOMContentLoaded', () => {
    bindFilter('classFilter', 'classesTable');
    bindSort('classesTable');
  });
</script>

</body>
</html>
